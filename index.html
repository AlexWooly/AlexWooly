<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>AlexWoo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="王凌奕的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="AlexWoo">
<meta property="og:url" content="https://alexwooly.gitee.io/index.html">
<meta property="og:site_name" content="AlexWoo">
<meta property="og:description" content="王凌奕的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="AlexWoo">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="AlexWoo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">AlexWoo</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">王凌奕的个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://alexwooly.gitee.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Docker常见指令大全及其详解整理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/19/Docker%E5%B8%B8%E8%A7%81%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8%E5%8F%8A%E5%85%B6%E8%AF%A6%E8%A7%A3%E6%95%B4%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2021-05-19T14:55:55.000Z" itemprop="datePublished">2021-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/19/Docker%E5%B8%B8%E8%A7%81%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8%E5%8F%8A%E5%85%B6%E8%AF%A6%E8%A7%A3%E6%95%B4%E7%90%86/">Docker常用指令大全及其详解整理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Docker常用指令大全及其详解整理"><a href="#Docker常用指令大全及其详解整理" class="headerlink" title="Docker常用指令大全及其详解整理"></a><strong>Docker常用指令大全及其详解整理</strong></h1><p>设置开机启动：systemctl enable docker</p>
<p>启动docker：systemctl start docker</p>
<p>查看版本：docker version </p>
<p>查看详细信息：docker info</p>
<h3 id="镜像操作"><a href="#镜像操作" class="headerlink" title="镜像操作"></a><strong>镜像操作</strong></h3><p>查看本地镜像：docker images </p>
<p>搜索镜像：docker search [name]      #name为你想拉取镜像的名字,如nginx，centos</p>
<p>搜索镜像并过滤是官方的： docker search –filter “is-official=true” [name]</p>
<p>搜索镜像并过滤大于多少颗星星的：docker search –filter stars=10 [name] </p>
<p>下载centos7镜像：docker pull centos:7   #不指定版本：7则为默认最新版本：latest </p>
<p>修改本地镜像名字（小写）：docker tag [本地镜像名称]  [想改的名称]    </p>
<p>本地镜像的删除：docker rmi centos:7</p>
<h3 id="阿里云镜像加速"><a href="#阿里云镜像加速" class="headerlink" title="阿里云镜像加速"></a><strong>阿里云镜像加速</strong></h3><p>配置步骤：vi /etc/docker/daemon.json </p>
<p>添加 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://5xok66d4.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>!!!注意，每个人的<a target="_blank" rel="noopener" href="https://5xok66d4.mirror.aliyuncs.com不一样,进入**https//cr.console.aliyun.com/cn-shenzhen/instances/mirrors">https://5xok66d4.mirror.aliyuncs.com不一样，进入**https://cr.console.aliyun.com/cn-shenzhen/instances/mirrors</a>** **查看</p>
<p>重启：systemctl daemon-reload &amp;&amp; systemctl restart docker</p>
<h3 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a><strong>容器操作</strong></h3><p>构建容器：docker run -itd –name=mycentos centos:7   #注意版本号的指定</p>
<p>-i ：表示以交互模式运行容器（让容器的标准输入保持打开）</p>
<p>-d：表示后台运行容器，并返回容器ID </p>
<p>-t：为容器重新分配一个伪输入终端 </p>
<p>–name：为容器指定名称</p>
<p>-p：端口映射  -p 80:8080 </p>
<p>-v：容器挂载，把容器内文件挂载到宿主机文件上，方便排查错误</p>
<p> 查看本地所有的容器：docker ps -a </p>
<p>查看本地正在运行的容器：docker ps </p>
<p>停止容器：docker stop CONTAINER_ID / CONTAINER_NAME</p>
<p> 一次性停止所有容器：docker stop $(docker ps -a -q) </p>
<p>启动容器：docker start CONTAINER_ID / CONTAINER_NAME </p>
<p>重启容器：docker restart CONTAINER_ID / CONTAINER_NAME </p>
<p>删除容器：docker rm CONTAINER_ID / CONTAINER_NAME </p>
<p>强制删除容器：docker rmi -f CONTAINER_ID / CONTAINER_NAME </p>
<p>查看容器详细信息：docker inspect CONTAINER_ID / CONTAINER_NAME </p>
<p>进入容器：docker exec -it 0ad5d7b2c3a4 /bin/bash</p>
<h3 id="容器的文件复制与挂载"><a href="#容器的文件复制与挂载" class="headerlink" title="容器的文件复制与挂载"></a><strong>容器的文件复制与挂载</strong></h3><p>从宿主机复制到容器：docker cp 宿主机本地路径 容器名字/ID：容器路径    docker cp /root/123.txt mycentos:/home/ </p>
<p>从容器复制到宿主机：docker cp 容器名字/ID：容器路径 宿主机本地路径     docker cp mycentos:/home/456.txt /root </p>
<p>宿主机文件夹挂载到容器里：docker run -itd -v 宿主机路径:容器路径 镜像ID    docker run -itd -v /root/xdclass/:/home centos:7</p>
<h3 id="自定义镜像"><a href="#自定义镜像" class="headerlink" title="自定义镜像"></a><strong>自定义镜像</strong></h3><ul>
<li><p>基于Docker Commit制作镜像 </p>
<p>docker commit 4eb9d14ebb18[原镜像id] mycentos:7[new名称] </p>
<p>docker commit -a “XD” -m “mkdir /home/xdclass” 4eb9d14ebb18 mcentos:7</p>
<p> -a：标注作者</p>
<p> -m：说明注释 </p>
<p>查看详细信息：docker inspect [container]</p>
</li>
<li><p>基于dockerfile制作镜像(主流的制作镜像方式)</p>
<ul>
<li><p>Dockerfile 指令</p>
<p>FROM 基于哪个镜像 </p>
<p>MAINTAINER 注明作者 </p>
<p>COPY 复制文件进入镜像（只能用相对路径，不能用绝对路径） </p>
<p>ADD 复制文件进入镜像（假如文件是.tar.gz文件会解压） </p>
<p>WORKDIR： 指定工作目录，假如路径不存在会创建路径 </p>
<p>ENV 设置环境变量 </p>
<p>EXPOSE 暴露容器端口 </p>
<p>RUN 在构建镜像的时候执行，作用于镜像层面 </p>
<p>ENTRYPOINT 在容器启动的时候执行，作用于容器层;dockerfile里有多条时只允许执行最后一条 </p>
<p>CMD 在容器启动的时候执行，作用于容器层;dockerfile里有多条时只允许执行最后一条;容器启动后执行默认的命令或者参数，允许被修改 </p>
<ul>
<li>命令格式：</li>
<li> shell命令格式：RUN yum install -y net-tools </li>
<li>exec命令格式：RUN [ “yum”,”install” ,”-y” ,”net-tools”]</li>
</ul>
</li>
</ul>
<p>构建：docker build -t mycentos:v2 .   （注意最后一个小点，.表示当前路径下，即在dockfile文件所在文件夹下进行操作）</p>
<ul>
<li><p>实例(对照上面语句进行复习)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is a dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> XD <span class="number">123456</span>@qq.com</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;正在构建镜像！！！&quot;</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/njuptwly</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> 123.txt /home/wlynjuptwly</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y net-tools</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u211-linux-x64.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mv /usr/<span class="built_in">local</span>/jdk1.8.0_211 /usr/<span class="built_in">local</span>/jdk</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="keyword">ENV</span> JRE_HOME=$JAVA_HOME/jre</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line"><span class="keyword">ENV</span> PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> apache-tomcat-8.5.35.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mv /usr/<span class="built_in">local</span>/apache-tomcat-8.5.35 /usr/<span class="built_in">local</span>/tomcat</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span>                                               <span class="comment">#暴露端口，允许访问</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/usr/local/tomcat/bin/catalina.sh&quot;</span>,<span class="string">&quot;run&quot;</span>]    <span class="comment">#安装好后进行启动</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="Docker-容器的网络模式"><a href="#Docker-容器的网络模式" class="headerlink" title="Docker 容器的网络模式"></a><strong>Docker 容器的网络模式</strong></h3><ul>
<li><p>bridge：桥接模式，该模式是docker 的默认网络设置，当Docker服务启动时，会在主机上创建一个名为docker0的虚拟网桥，并 选择一个和宿主机不同的IP地址和子网分配给docker0网桥</p>
</li>
<li><p>host：主机模式，该模式下容器是不会拥有自己的ip地址，而是使用宿主机的ip地址和端口。</p>
</li>
<li><p>none：无网络模式,无法连外网,内部调试用，很少用</p>
<p>查看网络模式： docker network ls</p>
</li>
</ul>
<h3 id="容器通信"><a href="#容器通信" class="headerlink" title="容器通信"></a><strong>容器通信</strong></h3><ul>
<li><p>基于link单向通信</p>
<p>docker run -itd –name tomcat_test –link mysql_test tomcat    #启动tomcat应用容器并link到mysql数据库（注意：mysql_test这个容器一定要存在！）</p>
</li>
<li><p>brige网桥实现双向通信</p>
<p>创建一个新的网桥：docker network create -d bridge my_bridge </p>
<p>启动第一个容器：docker run -itd –name tomcat_test tomcat </p>
<p>启动第二个容器：docker run -itd –name redis_test reds </p>
<p>把第一个容器加入网桥：docker network connect my_bridge tomcat_test </p>
<p>把第二个容器加入网桥：docker network connect my_bridge redis_test</p>
</li>
</ul>
<h3 id="容器的特权模式"><a href="#容器的特权模式" class="headerlink" title="容器的特权模式"></a><strong>容器的特权模式</strong></h3><p>启动一个普通的容器 docker run -itd –name mycentos centos:7 /bin/bash </p>
<p>安装网络工具： yum -y install net-tools </p>
<p>执行    route -n </p>
<p>删除网关： route del default gw 172.17.0.1 </p>
<p>启动拥有特权模式的容器： docker run -itd –privileged=true –name mycentos1 centos:7 /bin/bash </p>
<p>进入容器： docker exec -it ef /bin/bash </p>
<p>删除网关成功</p>
<h3 id="Volume数据共享"><a href="#Volume数据共享" class="headerlink" title="Volume数据共享"></a><strong>Volume数据共享</strong></h3><ul>
<li><p>dockerfile </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span> </span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/usr/local&quot;</span>] </span></span><br></pre></td></tr></table></figure>

<p>注意：在dockerfile里设置volume是无法修改宿主机的挂载路径的</p>
</li>
<li><p>使用volume容器共享创建nginx集群 </p>
<ul>
<li>使用–volumes-from 实现容器与容器之间volume共享 </li>
<li>创建nginx1 docker run -itd -p 8080:80 -v /usr/local/nginx/html:/usr/local/nginx/html –name nginx1 mycentos:nginx /usr/local/nginx/sbin/nginx -g “daemon off;”   #第一个容器与主机挂载</li>
<li>创建nginx2 docker run -itd -p 8081:80 –volumes-from nginx1 –name nginx2 mycentos:nginx /usr/local/nginx/sbin/nginx -g “daemon off;” </li>
<li>创建nginx3 docker run -itd -p 8082:80 –volumes-from nginx1 –name nginx3 mycentos:nginx /usr/local/nginx/sbin/nginx -g “daemon off;” </li>
<li>对/usr/local/nginx/html/index.html进行修改 打开浏览器进行访问测试</li>
<li>用docker inspect 容器ID 查看详细的挂载信息</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/19/Docker%E5%B8%B8%E8%A7%81%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8%E5%8F%8A%E5%85%B6%E8%AF%A6%E8%A7%A3%E6%95%B4%E7%90%86/" data-id="ckoy373ko0000as9i7qej89wp" data-title="Docker常用指令大全及其详解整理" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker常用指令" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/15/Docker%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" class="article-date">
  <time class="dt-published" datetime="2021-05-15T14:55:55.000Z" itemprop="datePublished">2021-05-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/15/Docker%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">Docker常用指令</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Docker常用指令"><a href="#Docker常用指令" class="headerlink" title="Docker常用指令"></a>Docker常用指令</h2><ul>
<li><p>常用命令（安装部署好Docker后，执行的命令是docker开头）,xxx是镜像名称</p>
</li>
<li><p>搜索镜像：docker search xxx</p>
</li>
<li><p>列出当前系统存在的镜像：docker images</p>
</li>
<li><p>拉取镜像：docker pull xxx</p>
<ul>
<li>xxx是具体某个镜像名称(格式 REPOSITORY:TAG)</li>
<li>REPOSITORY：表示镜像的仓库源,TAG：镜像的标签</li>
</ul>
</li>
<li><p>运行一个容器：</p>
<p>docker run –name nginx-xd -p 8080:80 -d nginx</p>
<p>docker run - 运行一个容器      </p>
<p>-d 后台运行</p>
<p> -p 端口映射</p>
<p> –name “xxx”  容器名称</p>
</li>
<li><p>列举当前运行的容器：docker ps</p>
</li>
<li><p>检查容器内部信息：docker inspect 容器名称</p>
</li>
<li><p>删除镜像：docker rmi IMAGE_NAME</p>
<ul>
<li>强制移除镜像不管是否有容器使用该镜像 增加 -f 参数</li>
</ul>
</li>
<li><p>停止某个容器：docker stop 容器名称</p>
</li>
<li><p>启动某个容器：docker start 容器名称</p>
</li>
<li><p>移除某个容器： docker rm 容器名称 （容器必须是停止状态）</p>
</li>
<li><p>列举全部 容器 ： docker ps -a</p>
</li>
<li><p>查看容器启动日志：docker logs -f containerid</p>
</li>
</ul>
<p><strong>阿里云私有镜像仓库创建</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;登录</span><br><span class="line">docker login --username&#x3D;【username】 registry.cn-shenzhen.aliyuncs.com</span><br><span class="line">&#x2F;&#x2F;打标签</span><br><span class="line">docker tag containerid registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-gateway:[版本号]</span><br><span class="line">&#x2F;&#x2F;推送</span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-gateway:[版本号]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/15/Docker%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" data-id="ckoq2jpu20000u69i263jhg81" data-title="Docker常用指令" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/14/Docker/" class="article-date">
  <time class="dt-published" datetime="2021-05-14T14:55:55.000Z" itemprop="datePublished">2021-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/14/Docker/">Docker介绍,使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Docker及在阿里云ecs上安装"><a href="#Docker及在阿里云ecs上安装" class="headerlink" title="Docker及在阿里云ecs上安装"></a>Docker及在阿里云ecs上安装</h2><h3 id="Docker介绍和使用场景"><a href="#Docker介绍和使用场景" class="headerlink" title="Docker介绍和使用场景"></a><strong>Docker介绍和使用场景</strong></h3><ul>
<li><p>官网：<a target="_blank" rel="noopener" href="https://www.docker.com/get-started">https://www.docker.com/get-started</a></p>
</li>
<li><p>什么是Dokcer</p>
<ul>
<li>百科:一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</li>
<li>容器是完全使用沙箱机制，相互之间不会有任何接口，使用go语言编写，在LCX（linux容器）基础上进行的封装</li>
<li>简单来说：<ul>
<li>就是可以快速部署启动应用</li>
<li>实现虚拟化，完整资源隔离</li>
<li>一次编写，四处运行</li>
<li>但有一定的限制，比如Docker是基于Linux 64bit的，无法在32bit的linux/Windows/unix环境下使用</li>
</ul>
</li>
</ul>
</li>
<li><p>为什么要用</p>
<ul>
<li>提供一次性的环境，假如需要安装Mysql，则需要安装很多依赖库、版本等，如果使用Docker则通过镜像就可以直接启动运行</li>
<li>快速动态扩容，使用docker部署了一个应用，可以制作成镜像，然后通过Dokcer快速启动</li>
<li>组建微服务架构，可以在一个机器上模拟出多个微服务，启动多个应用</li>
<li>更好的资源隔离和共享</li>
<li>一句话：开箱即用，快速部署，可移植性强，环境隔离</li>
</ul>
</li>
</ul>
<h3 id="阿里云ecs上安装docker"><a href="#阿里云ecs上安装docker" class="headerlink" title="阿里云ecs上安装docker"></a><strong>阿里云ecs上安装docker</strong></h3><ul>
<li><p>远程连接ECS实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">windows工具  putty，xshell, security CRT</span><br><span class="line">苹果系统MAC ： 通过终端登录   ssh root@ip 回车后输入密码</span><br></pre></td></tr></table></figure></li>
<li><p>依次运行以下命令添加yum源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list</span><br></pre></td></tr></table></figure></li>
<li><p>安装并运行Docker。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-io -y</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure></li>
<li><p>检查安装结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure></li>
<li><p>启动使用Docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker     #运行Docker守护进程</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker      #停止Docker守护进程   如果命令失效，直接kill进程</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker   #重启Docker守护进程</span><br></pre></td></tr></table></figure></li>
<li><p>更多文档</p>
<ul>
<li><pre><code>https://help.aliyun.com/document_detail/51853.html?spm=a2c4g.11186623.6.820.RaToNY
</code></pre>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/14/Docker/" data-id="ckoob38610000zvse1a6dbdwx" data-title="Docker介绍,使用" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-线程池" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/13/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" class="article-date">
  <time class="dt-published" datetime="2021-05-13T15:15:31.000Z" itemprop="datePublished">2021-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/13/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">线程池（篇九）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="线程池-非原创"><a href="#线程池-非原创" class="headerlink" title="线程池(非原创)"></a>线程池(非原创)</h1><h2 id="线程池是什么？"><a href="#线程池是什么？" class="headerlink" title="线程池是什么？"></a>线程池是什么？</h2><blockquote>
<p>java.util.concurrent.Executors提供了一个 java.util.concurrent.Executor接口的实现用于创建线程池</p>
</blockquote>
<p>线程的资源很宝贵，不可能无限的创建，必须要有管理线程的工具，线程池就是一种管理线程的工具，java开发中经常有池化的思想，如 数据库连接池、Redis连接池等。预先创建好一些线程，任务提交时直接执行，既可以节约创建线程的时间，又可以控制线程的数量。</p>
<h2 id="线程池的好处"><a href="#线程池的好处" class="headerlink" title="线程池的好处"></a>线程池的好处</h2><ol>
<li>降低资源消耗，通过池化思想，减少创建线程和销毁线程的消耗，重复利用的效果，节省资源</li>
<li>提高响应速度，任务到达时，无需创建线程即可运行，相对于从线程池拿线程，重新创建线程执行要慢很多</li>
<li>它帮我们管理线程，避免增加创建线程和销毁线程的资源损耗。因为线程本身也是一个对象，创建需要经过类加载，回收也要GC回收。</li>
</ol>
<h2 id="创建线程池"><a href="#创建线程池" class="headerlink" title="创建线程池"></a>创建线程池</h2><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, </span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime,TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">   												BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">   												ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">   												RejectedExecutionHandler handler)</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>核心参数</strong></p>
<p>corePoolSize：核心线程的数量<br>maximumPoolSize：线程池中最大的线程数量<br>keepAliveTime：线程池中非核心线程空闲的存活时间<br>TimeUnit：线程空闲存活时间的时间单位<br>workQueue：存放任务的阻塞队列<br>threadFactory：用于创建核心线程的线程工厂，可以给创建的线程自定义名字，方便查日志<br>handler：线程池的饱和策略（拒绝策略），有四种类型。</p>
<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><img src="/2021/05/13/%E7%BA%BF%E7%A8%8B%E6%B1%A0/xcc1.png" width="70%" height="60%">

<h3 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h3><ul>
<li>AbortPolicy：抛出一个异常，默认的拒绝策略</li>
<li>DiscardPolicy：直接丢弃任务</li>
<li>DiscardOldestPolicy：丢弃队列里最老的任务，将当前这个任务继续提交给线程池。</li>
<li>CallerRunsPolicy：交给线程池调用所在的线程进行处理。</li>
</ul>
<h3 id="线程池的工作队列"><a href="#线程池的工作队列" class="headerlink" title="线程池的工作队列"></a>线程池的工作队列</h3><p><strong>ArrayBlockingQueue</strong></p>
<p>有界队列，是一个用数组实现的有界阻塞队列，按FIFO排序。</p>
<p><strong>LinkedBlockingQueue</strong></p>
<p>基于链表实现的阻塞队列，按FIFO排序任务，容量可以设置，不设置的话将是一个无边界的阻塞队列（最大长度是Integet.Max_VLAUE），吞吐量通常要高于ArrayBlockingQueue；newFixedThreadPool线程池使用了这个队列。</p>
<p><strong>DelayQueue</strong></p>
<p>DelayQueue是一个任务定时周期延迟执行的队列。根据指定的执行从小到大排序，否则根据插入到队列的先后顺序。newScheduledThreadPool线程池使用了这个队列。</p>
<p><strong>PriorityBlockingQueue</strong></p>
<p>优先级队列是具有优先级的无界阻塞队列。</p>
<p><strong>SynchronousQueue</strong></p>
<p>同步队列，一个不存储元素的阻塞队列，每个插入操作都必须等待另一个线程调用移除操作，否则插入操作将一直处于阻塞状态。吞吐量通常要高于LinkedBlockingQueue，newCachedThreadPool使用了这个队列。</p>
<h3 id="常用线程池"><a href="#常用线程池" class="headerlink" title="常用线程池"></a>常用线程池</h3><ul>
<li>newFixedThreadPool（固定数目线程的线程池，内部使用LinkedBlockingQueue）</li>
<li>newCachedThreadPool（可缓存线程的线程池，内部使用SynchronousBlockingQueue）</li>
<li>newSingleThreadPool（单线程的线程池，内部使用LinkedBlockingQueue）</li>
<li>newScheduledThreadPool（定时及周期性执行的线程池，内部使用DelayQueue）</li>
</ul>
<p><strong>newFixedThreadPool</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</span><br><span class="line">                                      threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>线程池特点</p>
<ul>
<li>核心线程数量=最大线程数量</li>
<li>没有所谓的非空闲时间，即keepAliveTime=0</li>
<li>阻塞队列为无界队列LinkedBlockingQueue 提交任务的执行流程参照ThreadPoolExecutor及newFixedThreadPool自行得出。此处有</li>
<li>个问题：使用无界队列的线程池会导致内存飙升吗？答案是会的。因为如果提交的任务很多，超过了newFixedThreadPool设置的核</li>
<li>心线程数，会一直往无界队列里塞任务，任务累积越来越多，导致机器内存飙升，直到OOM。</li>
<li>使用场景：newFixedThreadPool适用于处理CPU密集型的任务，确保CPU在长期工作线程使用的情况下，尽可能少的分配线程。</li>
</ul>
<p><strong>newCachedThreadPool</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                   <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                   <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                                   threadFactory);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>线程池特点：</p>
<ul>
<li>核心线程数为0，最大线程树为Integer.Max_VALUE</li>
<li>非核心线程空闲的存活时间为60s</li>
<li>阻塞队列是SynchronousQueue</li>
<li>执行流程参照ThreadPoolExecutor和池特点自行得出。这个池也有一个问题：当提交任务的数量大于处理任务的数量时，每次提交一</li>
<li>个任务必然会创建一个非核心线程，极端情况下会创建过多的线程（最大Integer.Max_VALUE），耗尽CPU和内存资源。当然如果没</li>
<li>有任务了，这些空闲的非核心线程在存活60s后被回收。使用场景：用于并发量大执行大量短期的小任务。</li>
</ul>
<p><strong>newSingleThreadExecutor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">          (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</span><br><span class="line">                                  threadFactory));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>线程池特点：</p>
<ul>
<li>核心线程数=最大线程数=1，也就是这个池子里从始最终只有一个活着的线程。</li>
<li>keepAliveTime=0，这个参数无效。</li>
<li>阻塞队列是无界的LinkedBlockingQueue</li>
<li>提交任务的执行流程可自行得出。其实这个池子里干活的只有一个人，不管你往里塞多少任务，都是它按部就班的从队列里获取任务</li>
<li>执行，适用于串行执行任务的情景，一个任务接一个任务的执行。</li>
</ul>
<p><strong>newScheduledThreadPool</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="keyword">new</span> DelayedWorkQueue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>线程池特点：</p>
<ul>
<li>核心线程数自定义，最大线程数为Integer.MAX_VALUE</li>
<li>keepAliveTime=0</li>
<li>阻塞队列为DelayedWorkQueue 这里scheduleAtFixedRate和scheduleWithFixedDelay两个方法的区别如下：</li>
<li>scheduleAtFixedRate：按某种速率周期性的执行，不管上一个任务有没有执行结束。也就是说是从上一个任务开始执行算起的+一个</li>
<li>周期作为下一个任务的开始执行时间。</li>
<li>scheduleWithFixedDelay：在某个延迟后执行，是要等上一个任务执行结束算起的。也就是说是从上一个任务执行结束时间+一个周</li>
<li>期作为下一个任务的开始执行时间。</li>
<li>使用场景：周期性的执行任务的场景，做一些简单的定时调度。</li>
</ul>
<h3 id="线程池状态"><a href="#线程池状态" class="headerlink" title="线程池状态"></a>线程池状态</h3><p>RUNNING，SHUTDOWN，STOP，TIDYING，TERMINATED</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//线程池状态</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure>

<p><strong>RUNNING</strong></p>
<p>该状态的线程池会接收新任务，并处理阻塞队列中的任务<br>调用shutdown()方法可以切换到SHUTDOWN状态<br>调用shutdownNow()方法可以切换到STOP状态</p>
<p><strong>SHUTDOWN</strong></p>
<p>该状态的线程池不会接收新任务，但会处理阻塞队列中的任务<br>队列为空，并且线程池中执行的任务也为空，进入TIDYING状态</p>
<p><strong>STOP</strong></p>
<p>该状态的线程池不会接收新任务，也不会处理阻塞队列中的任务，而且会中断正在执行中的任务<br>线程池中执行的任务一旦变为空，进入TIDYING状态</p>
<p><strong>TIDYING</strong></p>
<p>该状态表明所有的任务已经运行终止，记录的任务数量为0<br>terminated()执行完毕，进入TERMINATED状态</p>
<p><strong>TERMINATED</strong></p>
<p>该状态表明线程池彻底终止或死亡</p>
<h3 id="常用并发工具类"><a href="#常用并发工具类" class="headerlink" title="常用并发工具类"></a>常用并发工具类</h3><p><strong>CountDownLatch和CyclicBarrier</strong></p>
<p>CountDownLatch具有计数器的功能，意思是主线程遇到CountDownLatch阻塞在那，要等待CountDownLatch里的所有线程都执行完毕，主线程才能继续执行。需要注意的是CountDownLatch创建的线程数和每个线程里countDown的总次数需要和初始化CountDownLatch传入的线程数相等，不然的话主线程将一直处于等待状态。</p>
<p>CyclicBarrier就是循环栅栏，意思是多个线程相互阻塞，只有多个线程都达到了栅栏时候，才能同时执行后续的逻辑。区别就是CountDownLatch是一个线程（或多个）等待另外的N个线程完成某个事情后才能执行。CyclicBarrier是N个线程相互等待，任何一个线程达到栅栏前，所有线程都阻塞在那。</p>
<p>下面给两个Demo<br>一个老师（主线程）等10个学生（其他线程）都来教室了才开始上课。是CountdownLatch模型。</p>
<p>public class CountDownLatchDemo {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer STUDENT_COUNT = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(STUDENT_COUNT);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">    Thread teacher = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Teacher());</span><br><span class="line">    teacher.start();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;STUDENT_COUNT; i++) &#123;</span><br><span class="line">        Thread student = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Student());</span><br><span class="line">        student.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;老师&quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;来了，等所有同学都到了才上课...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;所有同学都到齐了，开始上课...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;同学&quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;进入了教室...&quot;</span>);</span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个任务需要10个工人（10个线程）都到岗之后才能开始进行，否则只能等待，是CyclicBarrier模型。</p>
<p>public class CyclicBarrierDemo {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer WORKER_COUNT = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier cyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">    cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(WORKER_COUNT, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(WORKER_COUNT+<span class="string">&quot;个工人已就位，可以开始干活了...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;WORKER_COUNT; i++) &#123;</span><br><span class="line">        Thread worker = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker());</span><br><span class="line">        worker.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;工人&quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;就位...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Semaphore</strong></p>
<p>Semaphore信号量，就是用来控制访问有限资源的线程数量，线程要访问资源首先要获得许可证，一个许可证对应一个资源，如果资源不足了，线程就要等待，如果其他线程释放了一个资源（许可证），那么信号量就通知等待的一个线程，分配给它一个许可证。内部实现这里不再赘述，下面是4个人看电影，但是电影院只有2个位置，也就是一次只能2个人在里面看（这里限制不能站着看），有人离开位置，后面的人才可以进来看电影。</p>
<p>public class SemaphoreDemo {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer SETS_NUMBER = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer PERSON_NUMBER = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">    WatchMovie watchMovie = <span class="keyword">new</span> WatchMovie(SETS_NUMBER);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;PERSON_NUMBER; i++) &#123;</span><br><span class="line">        Thread person = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Person(watchMovie));</span><br><span class="line">        person.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WatchMovie</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">    WatchMovie(<span class="keyword">int</span> setCount) &#123;</span><br><span class="line">        semaphore = <span class="keyword">new</span> Semaphore(setCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watchMovie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取信号量</span></span><br><span class="line">            semaphore.acquire();</span><br><span class="line">            <span class="keyword">long</span> time = (<span class="keyword">long</span>) (Math.random()*<span class="number">10</span>+<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;看了&quot;</span>+time+<span class="string">&quot;秒的电影&quot;</span>);</span><br><span class="line">            Thread.sleep(time);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;让出座位，离开了电影院&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放信号量</span></span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WatchMovie watchMovie;</span><br><span class="line"></span><br><span class="line">    Person(WatchMovie watchMovie) &#123;</span><br><span class="line">        <span class="keyword">this</span>.watchMovie = watchMovie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        watchMovie.watchMovie();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Exchanger</strong></p>
<p>Exchanger理解其意思就行，就是线程间的数据交换。是怎么交换呢？实际上是共用一个Exchange的多个线程，在全部都到达栅栏的时候才可以进行数据的交换，否则的话先到达的线程只能等待其他的线程达到栅栏。那怎么才算到达栅栏呢，就是线程内部调用exchanger.exchange方法。然后这个方法的返回值就是其他线程交换的数据，参数就是当前线程想要交还给其他线程的数据。</p>
<h3 id="三大并发容器"><a href="#三大并发容器" class="headerlink" title="三大并发容器"></a><strong>三大并发容器</strong></h3><p>1.<strong>CopyOnWrite</strong></p>
<p>2.<strong>ConcurrentHashMap</strong></p>
<p>实现机制就是读写分离，简单的说就是任何时候都可以读，写需要加锁，写时复制。什么是写复制呢？就是对容器的修改加锁后，通过copy一个新的容器来进行修改，修改完毕后将容器替换为新的容器。</p>
<p><strong>Node数组+链表+红黑树</strong>(难到没有朋友，等有朝一日我学会了再来补充)</p>
<p>3.<strong>ConcurrentSkipListMap</strong></p>
<p>ConcurrentSkipListMap内部使用跳表的数据结构来实现，他的结构很简单。跳表就是一个多层的链表，底层是一个普通的链表，然后逐层减少，通常通过一个简单的算法实现每一层元素是下一层的元素的二分之一，这样当搜索元素时从最顶层开始搜索，可以说是另一种形式的二分查找。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/13/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" data-id="ckoo7ikei0000r69ific63o11" data-title="线程池（篇九）" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">Java多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-分布式架构理论" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/11/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%90%86%E8%AE%BA/" class="article-date">
  <time class="dt-published" datetime="2021-05-11T09:16:39.000Z" itemprop="datePublished">2021-05-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/11/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%90%86%E8%AE%BA/">分布式架构理论</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="分布式架构理论"><a href="#分布式架构理论" class="headerlink" title="分布式架构理论"></a>分布式架构理论</h2><h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>CAP定理: 指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可同时获得</p>
<ul>
<li><p>一致性（C）：所有节点都可以访问到最新的数据</p>
</li>
<li><p>可用性（A）：每个请求都是可以得到响应的，不管请求是成功还是失败</p>
</li>
<li><p>分区容错性（P）：除了全部整体网络故障，其他故障都不能导致整个系统不可用</p>
</li>
<li><p>CAP理论就是说在分布式存储系统中，最多只能实现上面的两点。而由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的。所以我们只能在一致性和可用性之间进行权衡</p>
<img src="/2021/05/11/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%90%86%E8%AE%BA/CAP1.png" width="40%" height="40%"></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CA： 如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但放弃P的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的</span><br><span class="line"></span><br><span class="line">CP: 如果不要求A（可用），每个请求都需要在服务器之间保持强一致，而P（分区）会导致同步时间无限延长(也就是等待数据同步完才能正常访问服务)，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统</span><br><span class="line"></span><br><span class="line">AP：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。</span><br></pre></td></tr></table></figure>

<h3 id="注册中心的选择"><a href="#注册中心的选择" class="headerlink" title="注册中心的选择"></a>注册中心的选择</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><strong>Nacos</strong></th>
<th align="left"><strong>Eureka</strong></th>
<th align="left"><strong>Consul</strong></th>
<th align="left"><strong>Zookeeper</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">一致性协议</td>
<td align="left">CP+AP</td>
<td align="left">AP</td>
<td align="left">CP</td>
<td align="left">CP</td>
</tr>
<tr>
<td align="left">健康检查</td>
<td align="left">TCP/HTTP/MYSQL/Client Beat</td>
<td align="left">心跳</td>
<td align="left">TCP/HTTP/gRPC/Cmd</td>
<td align="left">Keep Alive</td>
</tr>
<tr>
<td align="left">雪崩保护</td>
<td align="left">有</td>
<td align="left">有</td>
<td align="left">无</td>
<td align="left">无</td>
</tr>
<tr>
<td align="left">访问协议</td>
<td align="left">HTTP/DNS</td>
<td align="left">HTTP</td>
<td align="left">HTTP/DNS</td>
<td align="left">TCP</td>
</tr>
<tr>
<td align="left">SpringCloud集成</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
</tr>
</tbody></table>
<ul>
<li>分布式系统中P,肯定要满足，所以只能在CA中二选一</li>
<li>没有最好的选择，最好的选择是根据业务场景来进行架构设计</li>
<li>如果要求一致性，则选择zookeeper/Nacos，如金融行业 CP</li>
<li>如果要求可用性，则Eureka/Nacos，如电商系统 AP</li>
<li>CP ： 适合支付、交易类，要求数据强一致性，宁可业务不可用，也不能出现脏数据</li>
<li>AP: 互联网业务，比如信息流架构，不要求数据强一致，更想要服务可用</li>
</ul>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由来自 ebay 的架构师提出:CAP 中的一致性和可用性进行一个权衡的结果，核心思想就是：我们无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Basically Available(基本可用)</p>
<ul>
<li>假设系统，出现了不可预知的故障，但还是能用, 可能会有性能或者功能上的影响</li>
</ul>
</li>
<li><p>Soft state（软状态）</p>
<ul>
<li>允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时</li>
</ul>
</li>
<li><p>Eventually consistent（最终一致性）</p>
<ul>
<li>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/11/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%90%86%E8%AE%BA/" data-id="ckojts1g50001os9iekt4eqlj" data-title="分布式架构理论" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Java基本数据结构及其操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E5%85%B6%E6%93%8D%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T11:07:38.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E5%85%B6%E6%93%8D%E4%BD%9C/">Java基本数据结构及其操作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一-数组"><a href="#一-数组" class="headerlink" title="一.数组"></a>一.数组</h2><p>最常见数据结构</p>
<p>常用方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">array</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] b = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">        <span class="keyword">int</span> as = a.length;</span><br><span class="line">        <span class="keyword">int</span> a1 = a[<span class="number">1</span>];</span><br><span class="line">        Arrays.sort(a);</span><br><span class="line">        Integer[] c = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">        Arrays.sort(c, (o1, o2) -&gt; o1 - o2);         <span class="comment">//升序</span></span><br><span class="line">        Arrays.sort(c, (o1,o2) -&gt; o2.compareTo(o1)); <span class="comment">//降序</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Integer&gt; arr = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        System.out.println(arr.toString());</span><br><span class="line">        arr.add(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        arr.add(<span class="number">2</span>);</span><br><span class="line">        arr.remove(<span class="number">0</span>);  <span class="comment">//索引或元素本身</span></span><br><span class="line">        arr.set(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> arrs = arr.size();</span><br><span class="line">        <span class="keyword">boolean</span> is2 = arr.contains(<span class="number">2</span>);</span><br><span class="line">        Collections.sort(arr);</span><br><span class="line">        Collections.sort(arr,Collections.reverseOrder());</span><br><span class="line">        arr.sort(Collections.reverseOrder());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二-链表"><a href="#二-链表" class="headerlink" title="二.链表"></a>二.链表</h2><p>离散存储线性结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Linkedlist</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LinkedList&lt;Integer&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        System.out.println(list.toString());</span><br><span class="line">        list.add(<span class="number">2</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">int</span> element = list.get(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> index = list.indexOf(<span class="number">10</span>);</span><br><span class="line">        list.set(<span class="number">2</span>,<span class="number">11</span>);</span><br><span class="line">        list.remove(<span class="number">2</span>);  <span class="comment">//索引</span></span><br><span class="line">        <span class="keyword">int</span> length = list.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>leetcode常用自定义链表对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListNode</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val;</span><br><span class="line">        ListNode next = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListNode</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>leetcode的第19题记录ListNode的使用</p>
<p>给你一个链表，删除链表的倒数第 <code>n</code> 个结点，并且返回链表的头结点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">removeNthFromEnd</span><span class="params">(ListNode head, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        ListNode ans=<span class="keyword">new</span> ListNode(<span class="number">0</span>);<span class="comment">//定义一个头节点</span></span><br><span class="line">        ans.next=head;<span class="comment">//头节点指向这个链表</span></span><br><span class="line">        ListNode listnode = ans;<span class="comment">//每次调用这个链表只需要定义一个节点等于这个头节点</span></span><br><span class="line">        <span class="keyword">int</span> length=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(listnode.next!=<span class="keyword">null</span>)&#123;<span class="comment">//统计链表长度</span></span><br><span class="line">            length++;</span><br><span class="line">            listnode=listnode.next;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode temp =ans;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i&lt;length-n+<span class="number">1</span>;i++)&#123;</span><br><span class="line">            temp=temp.next;</span><br><span class="line">        &#125;</span><br><span class="line">        temp.next=temp.next.next;<span class="comment">//在倒数第n个位置前使链表的当前节点指向n的下一个位置</span></span><br><span class="line">        <span class="keyword">return</span> ans.next;<span class="comment">//这样做最后返回这个头节点的next就是返回了这个新的链表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三-队列"><a href="#三-队列" class="headerlink" title="三.队列"></a>三.队列</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tqueue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Queue&lt;Integer&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">3</span>);</span><br><span class="line">        System.out.println(queue.toString());</span><br><span class="line">        <span class="keyword">int</span> q1 = queue.peek();  <span class="comment">//get</span></span><br><span class="line">        <span class="keyword">int</span> q2 = queue.poll();  <span class="comment">//remove and get</span></span><br><span class="line">        <span class="keyword">boolean</span> it = queue.isEmpty();</span><br><span class="line">        <span class="keyword">int</span> size = queue.size();</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">int</span> tem = queue.poll();</span><br><span class="line">            System.out.println(tem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="四-栈"><a href="#四-栈" class="headerlink" title="四.栈"></a>四.栈</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Stack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TSatck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        stack.push(<span class="number">1</span>);</span><br><span class="line">        stack.push(<span class="number">2</span>);</span><br><span class="line">        stack.push(<span class="number">3</span>);</span><br><span class="line">        System.out.println(stack.toString());</span><br><span class="line">        stack.peek();</span><br><span class="line">        stack.pop();</span><br><span class="line">        stack.size();</span><br><span class="line">        stack.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五-哈希表"><a href="#五-哈希表" class="headerlink" title="五.哈希表"></a>五.哈希表</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThashTable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;Integer,String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.size();</span><br><span class="line">        map.isEmpty();</span><br><span class="line">        map.containsKey(<span class="number">1</span>);</span><br><span class="line">        map.containsValue(<span class="string">&quot;wly&quot;</span>);</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="string">&quot;wly&quot;</span>);</span><br><span class="line">        map.get(<span class="number">1</span>);</span><br><span class="line">        map.remove(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="六-堆"><a href="#六-堆" class="headerlink" title="六.堆"></a>六.堆</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Theap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PriorityQueue&lt;Integer&gt; minHeap = <span class="keyword">new</span> PriorityQueue&lt;Integer&gt;();</span><br><span class="line">        PriorityQueue&lt;Integer&gt; maxHeap = <span class="keyword">new</span> PriorityQueue&lt;Integer&gt;(<span class="number">11</span>,<span class="keyword">new</span> Comparator&lt;Integer&gt;()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer i1,Integer i2)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i2.compareTo(i1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//PriorityQueue&lt;Integer&gt; maxheap = new PriorityQueue&lt;&gt;(Collections.reverseOrder());</span></span><br><span class="line">        minHeap.peek();</span><br><span class="line">        maxHeap.poll();</span><br><span class="line">        maxHeap.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七-集合"><a href="#七-集合" class="headerlink" title="七.集合"></a>七.集合</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tset</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HashSet&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        set.add(<span class="number">1</span>);</span><br><span class="line">        set.add(<span class="number">1</span>);</span><br><span class="line">        set.add(<span class="number">2</span>);</span><br><span class="line">        set.add(<span class="number">3</span>);</span><br><span class="line">        set.contains(<span class="number">2</span>);</span><br><span class="line">        set.remove(<span class="number">2</span>);</span><br><span class="line">        set.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/07/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E5%85%B6%E6%93%8D%E4%BD%9C/" data-id="ckojts1g20000os9i3j3h09ga" data-title="Java基本数据结构及其操作" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">Java数据结构</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-常用sql（MySQL）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/06/%E5%B8%B8%E7%94%A8sql%EF%BC%88MySQL%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2021-05-06T13:54:06.000Z" itemprop="datePublished">2021-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/06/%E5%B8%B8%E7%94%A8sql%EF%BC%88MySQL%EF%BC%89/">常用sql（MySQL）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="MySQL中常用sql语句"><a href="#MySQL中常用sql语句" class="headerlink" title="MySQL中常用sql语句"></a>MySQL中常用sql语句</h1><p>关于sql语句的学习W3school 刷题LeetCode</p>
<p>部分只记录下我掌握不熟练的语句和用法</p>
<p>1.distinct 列出不同的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Student <span class="keyword">FROM</span> School </span><br></pre></td></tr></table></figure>

<p>2.update</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE 表名称 <span class="keyword">SET</span> 列名称 <span class="operator">=</span> 新值 <span class="keyword">WHERE</span> 列名称 <span class="operator">=</span> 某值</span><br><span class="line">UPDATE Person <span class="keyword">SET</span> FirstName <span class="operator">=</span> <span class="string">&#x27;Fred&#x27;</span> <span class="keyword">WHERE</span> LastName <span class="operator">=</span> <span class="string">&#x27;Wilson&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>3.delete</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> 表名称 <span class="keyword">WHERE</span> 列名称 <span class="operator">=</span> 值</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> Person <span class="keyword">WHERE</span> LastName <span class="operator">=</span> <span class="string">&#x27;Wilson&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>4.order by 语句用于对结果集进行排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Company, OrderNumber <span class="keyword">FROM</span> Orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> Company, OrderNumber</span><br><span class="line"><span class="keyword">SELECT</span> Company, OrderNumber <span class="keyword">FROM</span> Orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> Company <span class="keyword">DESC</span>    <span class="operator">/</span><span class="operator">/</span>逆序</span><br></pre></td></tr></table></figure>

<p>5.通配符</p>
<table>
<thead>
<tr>
<th>%</th>
<th align="center">替代一个或多个字符</th>
</tr>
</thead>
<tbody><tr>
<td>_</td>
<td align="center">仅替代一个字符</td>
</tr>
<tr>
<td>[charlist]</td>
<td align="center">字符列中的任何单一字符</td>
</tr>
<tr>
<td>[^charlist]或者[!charlist]</td>
<td align="center">不在字符列中的任何单一字符</td>
</tr>
</tbody></table>
<p>6.as 指定别名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LastName <span class="keyword">AS</span> Family, FirstName <span class="keyword">AS</span> Name</span><br><span class="line"><span class="keyword">FROM</span> Persons <span class="keyword">AS</span> p</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>JOIN</p>
<p>​        left join :左连接，返回左表中所有的记录以及右表中连接字段相等的记录。</p>
<p>　　right join :右连接，返回右表中所有的记录以及左表中连接字段相等的记录。</p>
<p>　　inner join: 内连接，又叫等值连接，只返回两个表中连接字段相等的行。</p>
<p>　　full join:外连接，返回两个表中的行：left join + right join。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Persons.LastName, Persons.FirstName, Orders.OrderNo</span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Persons.Id_P <span class="operator">=</span> Orders.Id_P</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Persons.LastName</span><br></pre></td></tr></table></figure></li>
<li><p>UNION 操作符用于合并两个或多个 SELECT 语句的结果集</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table_name1</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table_name2</span><br></pre></td></tr></table></figure>

<p>默认地，UNION 操作符选取不同的值。如果允许重复的值，使用 UNION ALL</p>
</li>
<li><p>SELECT INTO 语句从一个表中选取数据，然后把数据插入另一个表中。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">INTO</span> new_table_name [<span class="keyword">IN</span> externaldatabase] </span><br><span class="line"><span class="keyword">FROM</span> old_tablename</span><br></pre></td></tr></table></figure></li>
<li><p>Date</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_now.asp">NOW()</a></td>
<td align="left">返回当前的日期和时间</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_curdate.asp">CURDATE()</a></td>
<td align="left">返回当前的日期</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_curtime.asp">CURTIME()</a></td>
<td align="left">返回当前的时间</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_date.asp">DATE()</a></td>
<td align="left">提取日期或日期/时间表达式的日期部分</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_extract.asp">EXTRACT()</a></td>
<td align="left">返回日期/时间按的单独部分</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_date_add.asp">DATE_ADD()</a></td>
<td align="left">给日期添加指定的时间间隔</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_date_sub.asp">DATE_SUB()</a></td>
<td align="left">从日期减去指定的时间间隔</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_datediff_mysql.asp">DATEDIFF()</a></td>
<td align="left">返回两个日期之间的天数</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/sql/func_date_format.asp">DATE_FORMAT()</a></td>
<td align="left">用不同的格式显示日期/时间</td>
</tr>
</tbody></table>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL 使用下列数据类型在数据库中存储日期或日期<span class="operator">/</span>时间值：</span><br><span class="line"></span><br><span class="line"><span class="type">DATE</span> <span class="operator">-</span> 格式 YYYY<span class="operator">-</span>MM<span class="operator">-</span>DD</span><br><span class="line">DATETIME <span class="operator">-</span> 格式: YYYY<span class="operator">-</span>MM<span class="operator">-</span>DD HH:MM:SS</span><br><span class="line"><span class="type">TIMESTAMP</span> <span class="operator">-</span> 格式: YYYY<span class="operator">-</span>MM<span class="operator">-</span>DD HH:MM:SS</span><br><span class="line"><span class="keyword">YEAR</span> <span class="operator">-</span> 格式 YYYY 或 YY</span><br></pre></td></tr></table></figure>

<p>11.IS NULL 和 IS NOT NULL 操作符</p>
<p>函数</p>
<p>1.count</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(Customer) <span class="keyword">AS</span> CustomerNilsen <span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WHERE</span> Customer<span class="operator">=</span><span class="string">&#x27;Carter&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2.FIRST() 函数返回指定的字段中第一个记录的值。Last( )</p>
<p>配合 ORDER BY 语句对记录进行排序。 MAX（）MIN( )</p>
<p>3.SUM( )</p>
<p>4.GROUP BY 语句</p>
<p>GROUP BY 语句用于结合合计函数，根据一个或多个列对结果集进行分组</p>
<p>5.HAVING 子句</p>
<p>在 SQL 中增加 HAVING 子句原因是，WHERE 关键字无法与合计函数一起使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Customer,<span class="built_in">SUM</span>(OrderPrice) <span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Customer</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">SUM</span>(OrderPrice)<span class="operator">&lt;</span><span class="number">2000</span></span><br></pre></td></tr></table></figure>

<p>6.UCASE( ),LCASE( )大小写转换</p>
<ol start="7">
<li>LEN( ) 函数返回文本字段中值的长度。</li>
<li>ROUND 函数用于把数值字段舍入为指定的小数位数</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUND(column_name,decimals) <span class="keyword">FROM</span> table_name</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>FORMAT 函数用于对字段的显示进行格式化</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> FORMAT(column_name,format) <span class="keyword">FROM</span> table_name</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/06/%E5%B8%B8%E7%94%A8sql%EF%BC%88MySQL%EF%BC%89/" data-id="ckod38s9x0000sc9ih6u0c3tu" data-title="常用sql（MySQL）" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Redis3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/05/Redis3/" class="article-date">
  <time class="dt-published" datetime="2021-05-05T15:18:15.000Z" itemprop="datePublished">2021-05-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/05/Redis3/">Redis 事务</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Redis-第三篇-Redis-事务"><a href="#Redis-第三篇-Redis-事务" class="headerlink" title="Redis 第三篇 Redis 事务"></a>Redis 第三篇 Redis 事务</h1><p>回到很多人抢购库存剩余为1的场景，抢购的时候是一个并发操作，系统发来多个并发请求。这批请求有的执行略慢，查询到库存为 0 于是购买失败；但有的请求执行较快，查询到数据库商品余量都是 1 个，然后都通过这一个余量判断，然后导致超发的情况。前面我们通过锁来解决。</p>
<blockquote>
<p>线程执行先后顺序和快慢，都是由操作系统、CPU 自动决定的，开发者无法预测</p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>事务(Transaction) ，是指将一个业务逻辑作为一个整体一起执行。事务其实就是打包一组操作（或者命令）作为一个整体，在事务处理时将顺序执行这些操作，并返回结果，如果其中任何一个环节出错，所有的操作将被回滚。</p>
<p>redis 的事务指的是提供一种将多个命令打包，一次性按顺序地执行</p>
<p>redis 的事务可以保证只有在执行完事务中的所有命令后，才会继续处理此客户端的其他命令。也就是说只有一个用户可以操作事务当中的数据</p>
<h2 id="Redis-事务从开始到结束的三个过程"><a href="#Redis-事务从开始到结束的三个过程" class="headerlink" title="Redis 事务从开始到结束的三个过程"></a>Redis 事务从开始到结束的三个过程</h2><p><strong>开启事务 -&gt; 命令入列 -&gt;执行事务/放弃事务</strong></p>
<h3 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h3><p>四大指令：MULTI、EXEC、DISCARD、WATCH</p>
<p><strong>MULTI</strong>：开启一个事物</p>
<p><strong>EXEC</strong>：执行一个事物</p>
<p><strong>DISCARD</strong>：取消一个事物</p>
<p><strong>WATCH</strong>：用于客户端并发情况下，为事务提供一个锁（CAS，Check And Set）可以用 watch 命令来监控一个或多个变量如果在执行事务之前，某个监控项被修改了，那么整个事务就会终止执行（必须写在事务的前面，不能写在事务当中）</p>
<h3 id="对Redis-数据初始化的说明"><a href="#对Redis-数据初始化的说明" class="headerlink" title="对Redis 数据初始化的说明"></a>对Redis 数据初始化的说明</h3><p>既然 Redis 是缓存，就要考虑到什么时机把初始数据存入到数据库。下演示代码只是一种最简单的情况，抢购前从数据库里查库存，然后放入 Redis。实际上也可以在项目启动时初始化，在标记为 @PostConstruct 的方法中把输入存入 Redis。</p>
<h3 id="执行事务"><a href="#执行事务" class="headerlink" title="执行事务"></a>执行事务</h3><p>一般为固定写法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;List&lt;Object&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>图示理解</p>
<img src="/2021/05/05/Redis3/Redis3-1.png" width="60%" height="60%">

<h3 id="模拟抢购实例代码（Redis事务版）"><a href="#模拟抢购实例代码（Redis事务版）" class="headerlink" title="模拟抢购实例代码（Redis事务版）"></a>模拟抢购实例代码（Redis事务版）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title">snappedUp</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化返回数据</span></span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.data(<span class="keyword">true</span>);</span><br><span class="line">        result.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//实现购买代码</span></span><br><span class="line">        <span class="comment">//先去redis查询一下</span></span><br><span class="line">        Object value = redisTemplate.opsForValue().get(id);</span><br><span class="line">        <span class="keyword">int</span> stock = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//如果redis没有则去数据库查询</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//去数据库查询该商品的信息</span></span><br><span class="line">            ProductDO product = productDAO.selectById(id);</span><br><span class="line">            <span class="comment">//将信息缓存到redis里边</span></span><br><span class="line">            stock = product.getStock();</span><br><span class="line">            redisTemplate.opsForValue().set(product.getId(), stock);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stock = (<span class="keyword">int</span>)value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;List&lt;Object&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                Integer stock = (Integer)operations.opsForValue().get(id);</span><br><span class="line">                <span class="comment">//判断该商品的库存是否大于1</span></span><br><span class="line">                <span class="keyword">if</span> (Integer.valueOf(stock) &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">//监听商品的名字，redis里边的key  注意！！！！监听的不是stock而是商品id</span></span><br><span class="line">                    operations.watch(id);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//开启事务</span></span><br><span class="line">                    operations.multi();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将该商品的库存自减1</span></span><br><span class="line">                    operations.opsForValue().set(id, stock - <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">//修改mysql数据库库存数量</span></span><br><span class="line">                    ProductDO productDO = <span class="keyword">new</span> ProductDO();</span><br><span class="line">                    productDO.setId(id);</span><br><span class="line">                    productDO.setStock(stock - <span class="number">1</span>);</span><br><span class="line">                    productDAO.updateStock(productDO);</span><br><span class="line">                    <span class="comment">// 执行事务</span></span><br><span class="line">                    List exec = operations.exec();</span><br><span class="line">                    <span class="keyword">if</span> (exec.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span>可以有其它业务逻辑，例如插入订单等，视具体需求而定</span></span><br><span class="line">                        result.setMessage(<span class="string">&quot;抢购成功&quot;</span>);</span><br><span class="line">                        result.setData(<span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        result.setMessage(<span class="string">&quot;抢购失败&quot;</span>);</span><br><span class="line">                        result.setData(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> exec;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result.setMessage(<span class="string">&quot;商品库存不足&quot;</span>);</span><br><span class="line">                    result.setData(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>










      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/05/Redis3/" data-id="ckocjcpjg0000r29i4p4y5eki" data-title="Redis 事务" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Redis2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/04/Redis2/" class="article-date">
  <time class="dt-published" datetime="2021-05-04T15:18:15.000Z" itemprop="datePublished">2021-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/04/Redis2/">Redission</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Redis-第二篇-Redission"><a href="#Redis-第二篇-Redission" class="headerlink" title="Redis 第二篇 Redission"></a>Redis 第二篇 Redission</h1><p>上篇在写客户端的时候提到了我用的比较多的Redission，这节就顺着整理一下。</p>
<p>spring-boot-data-redis 默认使用 Lettuce 客户端操作数据。但Reddissin 很强大，它提供的功能远远超出了一个 Redis 客户端的范畴，使用它来替换默认的 Lettuce。在可以使用基本 Redis 功能的同时，也能使用它提供的一些高级服务：</p>
<ul>
<li>远程调用 </li>
<li>分布式锁 </li>
<li>分布式对象、容器</li>
</ul>
<p>简单讲一下分布式：分布式结构就是将一个完整的系统,按照业务功能,拆分成一个个独立的子系统,在分布式结构中，每个子系统就被称为“服务”。（演变过程：单机结构 -&gt; 集群结构 -&gt; 分布式结构）</p>
<h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="application-properties配置"><a href="#application-properties配置" class="headerlink" title="application.properties配置"></a>application.properties配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;redis启动主机ip</span><br><span class="line">spring.redis.host&#x3D;</span><br><span class="line">&#x2F;&#x2F;redis端口号</span><br><span class="line">spring.redis.port&#x3D;</span><br><span class="line">&#x2F;&#x2F;redis登录密码</span><br><span class="line">spring.redis.password&#x3D;</span><br></pre></td></tr></table></figure>

<h2 id="两个常用应用"><a href="#两个常用应用" class="headerlink" title="两个常用应用"></a>两个常用应用</h2><h3 id="一-分布式ID"><a href="#一-分布式ID" class="headerlink" title="一.分布式ID"></a>一.分布式ID</h3><p>ID 是数据的唯一标识，传统的做法是利用 UUID 和数据库的自增 ID。</p>
<p>但由于 UUID 是无序的，不能附带一些其他信息。比如需要生成员工号，这个一般是用数据库递增， UUID 是无法完成这个需求的。</p>
<p>再来说自增 ID，随着业务的发展，数据量会越来越大，需要对数据进行分表，甚至分库。分表后每个表的数据会按自己的节奏来自增，这样会造成 ID 冲突，这时就需要一个单独的机制来负责生成唯一 ID。</p>
<p>举例：淘宝的订单号</p>
<p>代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.redisson.api.RAtomicLong;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoIdController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getautoid&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAutoId</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//格式化格式为年月日</span></span><br><span class="line">        DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line">        <span class="comment">//获取当前时间</span></span><br><span class="line">        String now = LocalDate.now().format(dateTimeFormatter);</span><br><span class="line">        <span class="comment">//通过redis的自增获取序号</span></span><br><span class="line">        RAtomicLong atomicLong = redissonClient.getAtomicLong(now);</span><br><span class="line">        atomicLong.expire(<span class="number">1</span>, TimeUnit.DAYS);</span><br><span class="line">        <span class="comment">//拼装订单号</span></span><br><span class="line">        <span class="keyword">return</span> now + <span class="string">&quot;&quot;</span> + atomicLong.incrementAndGet();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">202105041</span><br></pre></td></tr></table></figure>

<p>嫌不够长，还可以这样<strong>String.format(“%08d”, xxx);</strong>%04d 表示输出时指定格式为使用 0 在左侧补齐至 8 位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> now + <span class="string">&quot;&quot;</span> + String.format(<span class="string">&quot;%08d&quot;</span>,atomicLong.incrementAndGet());</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">202105040000002</span><br></pre></td></tr></table></figure>

<h3 id="二-分布式锁"><a href="#二-分布式锁" class="headerlink" title="二.分布式锁"></a>二.分布式锁</h3><p>锁，在 Java 中 synchronized 关键字很常见，这些都是<strong>本地锁</strong>，只能解决一台服务器并发问题。</p>
<p>但是随着业务量不断增大，单机结构不满足那么大的访问量，需要变成集群或者分布式结构，因此无法保证某个数据的改变是同一台服务器操作的。我们需要的是一个能锁所有服务器的锁，这时就需要<strong>分布式锁</strong>。</p>
<h4 id="实现Redis分布-三步"><a href="#实现Redis分布-三步" class="headerlink" title="实现Redis分布  三步"></a><strong>实现Redis分布  三步</strong></h4><h5 id="取得锁"><a href="#取得锁" class="headerlink" title="取得锁"></a>取得锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CUSTOM_NAME 自定义锁名称字符串，一般是跟业务相关的名称</span></span><br><span class="line"> <span class="comment">//Rlock 继承于 java.util.concurrent.locks.Lock;(又是Lock类！！)</span></span><br><span class="line"> RLock rLock = redissonClient.getLock(<span class="string">&quot;CUSTOM_NAME&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="上锁"><a href="#上锁" class="headerlink" title="上锁"></a>上锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上锁过程</span></span><br><span class="line"><span class="comment"> * 两种常用上锁方式tryLock()或者lock()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> rLock.tryLock();</span><br></pre></td></tr></table></figure>

<h5 id="解锁-有上锁就必须解锁，否则会导致死锁，系统也就卡死了。"><a href="#解锁-有上锁就必须解锁，否则会导致死锁，系统也就卡死了。" class="headerlink" title="解锁(有上锁就必须解锁，否则会导致死锁，系统也就卡死了。)"></a>解锁(有上锁就必须解锁，否则会导致死锁，系统也就卡死了。)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解锁</span></span><br><span class="line"> rLock.unlock();</span><br></pre></td></tr></table></figure>

<p>代码实操，模拟商品购买</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">`<span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Product&gt; products = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(ProductController.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        products.add(<span class="keyword">new</span> Product(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">        products.add(<span class="keyword">new</span> Product(<span class="string">&quot;2&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/purchase&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">purchase</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取分布式锁</span></span><br><span class="line">        RLock transferLock = redissonClient.getLock(<span class="string">&quot;PURCHASE&quot;</span>);</span><br><span class="line"></span><br><span class="line">        transferLock.lock();</span><br><span class="line">        <span class="comment">//业务逻辑卸载try...catch中 ，finally最后一定要释放锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//尝试获取锁</span></span><br><span class="line">            Product product = findById(<span class="string">&quot;1&quot;</span>); <span class="comment">//为了方便测试，直接写死，实际商品代码应有用户post</span></span><br><span class="line">            <span class="keyword">if</span> (product.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;商品已经卖完啦！！！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            product.setStock(product.getStock() - <span class="number">1</span>);</span><br><span class="line">            updateProduct(product);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;商品购买成功！！！&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;&quot;</span>,e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 无论是否出现异常，一定解锁</span></span><br><span class="line">            transferLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;商品购买失败&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询商品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 唯一id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Product</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Product <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            <span class="keyword">if</span> (product.getId().equals(id)) &#123;</span><br><span class="line">                <span class="keyword">return</span> product;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Product <span class="title">updateProduct</span><span class="params">(Product product)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; products.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (products.get(i).getId().equals(product.getId())) &#123;</span><br><span class="line">                products.set(i, product);</span><br><span class="line">                <span class="keyword">return</span> product;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Product类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.youkeda.app.model;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zr</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/2, 周二</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品唯一Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 库存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long stock = <span class="number">2L</span>;  <span class="comment">//方便测试，请求到第三次时应该为购买失败</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Product</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getStock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStock</span><span class="params">(<span class="keyword">final</span> Long stock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stock = stock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>请求三次时</p>
<img src="/2021/05/04/Redis2/Redis2.png" width="90%" height="90%">
      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/04/Redis2/" data-id="ckoa6j9nm0003669icvgfaiyd" data-title="Redission" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-无锁cas(八)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/04/%E6%97%A0%E9%94%81cas(%E5%85%AB)/" class="article-date">
  <time class="dt-published" datetime="2021-05-04T06:50:23.000Z" itemprop="datePublished">2021-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/04/%E6%97%A0%E9%94%81cas(%E5%85%AB)/">无锁cas（篇八）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Java多线程-第八篇-无锁cas"><a href="#Java多线程-第八篇-无锁cas" class="headerlink" title="Java多线程 第八篇 无锁cas"></a>Java多线程 第八篇 无锁cas</h2><p>对于并发控制而言，锁是一种悲观策略，会阻塞线程执行。而无锁是一种乐观策略，它会假设对资源的访问时没有冲突的，既然没有冲突就不需要等待，线程不需要阻塞。那多个线程共同访问临界区的资源怎么办呢，无锁的策略采用一种比较交换技术<strong>CAS（compare and swap）</strong>来鉴别线程冲突，一旦检测到冲突，就重复当前操作直到没有冲突为止。</p>
<h3 id="CAS无锁实现原理"><a href="#CAS无锁实现原理" class="headerlink" title="CAS无锁实现原理"></a>CAS无锁实现原理</h3><h5 id="CAS算法"><a href="#CAS算法" class="headerlink" title="CAS算法"></a>CAS算法</h5><p>一个CAS方法包含三个参数CAS(V,E,N)。V表示要更新的变量，E表示预期的值，N表示新值。只有当V的值等于E时，才会将V的值修改为N。如果V的值不等于E，说明已经被其他线程修改了，当前线程可以放弃此操作，也可以再次尝试次操作直至修改成功。基于这样的算法，CAS操作即使没有锁，也可以发现其他线程对当前线程的干扰（临界区值的修改），并进行恰当的处理。其中当前线程可以发现其他线程对临界区数据的修改，这点可以使用 volatile 进行保证,volatile 实现了JMM中的<strong>可见性</strong>。使得对临界区资源的修改可以马上被其他线程看到，它是通过添加内存屏障实现的。</p>
<h5 id="juc并发包下包含了实现了cas的原子类"><a href="#juc并发包下包含了实现了cas的原子类" class="headerlink" title="juc并发包下包含了实现了cas的原子类"></a>juc并发包下包含了实现了cas的原子类</h5><p>1.AtomicInteger/AtomicBoolean/AtomicLong<br>2.AtomicIntegerArray/AtomicLongArray/AtomicReferenceArray<br>3.AtomicReference/AtomicStampedReference/AtomicMarkableReference</p>
<h5 id="最常用AtomicInteger"><a href="#最常用AtomicInteger" class="headerlink" title="最常用AtomicInteger"></a>最常用AtomicInteger</h5><p>源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此处省略一万字代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Atomically sets to the given value and returns the old value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newValue the new value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndSet</span><span class="params">(<span class="keyword">int</span> newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = get();</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, newValue))</span><br><span class="line">            <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Atomically sets the value to the given updated value</span></span><br><span class="line"><span class="comment"> * if the current value &#123;<span class="doctag">@code</span> ==&#125; the expected value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expect the expected value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> update the new value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if successful. False return indicates that</span></span><br><span class="line"><span class="comment"> * the actual value was not equal to the expected value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>AtomicInteger中真正存储数据的是value变量，而改变量是被<strong>volatile</strong>修饰的，保证了线程直接的可见性。还记得Integer中的value吗？Integer中的value是被final修饰的，是不可变对象。<br>getAndSet方法通过一个死循环不断尝试赋值操作。而真正的赋值操作交给了<strong>unsafe类</strong>来实现。</p>
<h5 id="unsafe"><a href="#unsafe" class="headerlink" title="unsafe"></a>unsafe</h5><p><em><strong>Unsafe</strong></em>类是CAS实现的核心</p>
<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class var0 = Reflection.getCallerClass();</span><br><span class="line">    <span class="keyword">if</span>(var0.getClassLoader() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;Unsafe&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> theUnsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里<code>Unsafe</code>封装了一些类似于<strong>C++中指针</strong>的东西，该类中的方法都是<code>native</code>的，而且是<strong>原子</strong>的操作。原子性是通过CAS原子指令实现的，由处理器保证。</p>
<h3 id="CAS问题"><a href="#CAS问题" class="headerlink" title="CAS问题"></a>CAS问题</h3><p>1.<strong>ABA问题</strong></p>
<p>ABA：一个线程将某一内存地址中的数值A改成了B，接着又改成了A，此时CAS认为是没有变化，其实是已经变化过了，而这个问题的解决方案可以使用版本号标识，每操作一次version加1。在java5中，已经提供了AtomicStampedReference来解决问题。</p>
<p>2.<strong>CAS造成CPU利用率增加</strong></p>
<p>3.<strong>会增加程序测试的复杂度</strong></p>
<p>4.<strong>只能保证一个共享变量的原子操作</strong></p>
<h3 id="jdk中的CAS实现"><a href="#jdk中的CAS实现" class="headerlink" title="jdk中的CAS实现"></a>jdk中的CAS实现</h3><h5 id="java-util-concurrent-atomic包"><a href="#java-util-concurrent-atomic包" class="headerlink" title="java.util.concurrent.atomic包"></a>java.util.concurrent.atomic包</h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexwooly.gitee.io/2021/05/04/%E6%97%A0%E9%94%81cas(%E5%85%AB)/" data-id="cko9mlwvo0000889i3p1z7zrk" data-title="无锁cas（篇八）" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">Java多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">Java多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%B7%A5%E5%85%B7%E7%B1%BB/" rel="tag">Java工具类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">Java数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 16.67px;">Docker</a> <a href="/tags/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 20px;">Java多线程</a> <a href="/tags/Java%E5%B7%A5%E5%85%B7%E7%B1%BB/" style="font-size: 13.33px;">Java工具类</a> <a href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;">Java数据结构</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Redis/" style="font-size: 16.67px;">Redis</a> <a href="/tags/jwt/" style="font-size: 13.33px;">jwt</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 10px;">微服务</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/19/Docker%E5%B8%B8%E8%A7%81%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8%E5%8F%8A%E5%85%B6%E8%AF%A6%E8%A7%A3%E6%95%B4%E7%90%86/">Docker常用指令大全及其详解整理</a>
          </li>
        
          <li>
            <a href="/2021/05/15/Docker%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">Docker常用指令</a>
          </li>
        
          <li>
            <a href="/2021/05/14/Docker/">Docker介绍,使用</a>
          </li>
        
          <li>
            <a href="/2021/05/13/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">线程池（篇九）</a>
          </li>
        
          <li>
            <a href="/2021/05/11/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E7%90%86%E8%AE%BA/">分布式架构理论</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 AlexWoo<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
     </div>
<div>
 {% if theme.footer.beian.enable %}{#
#}  {{ next_url('http://www.miitbeian.gov.cn', theme.footer.beian.icp ) }}
{% endif %}
</div>
</div>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>